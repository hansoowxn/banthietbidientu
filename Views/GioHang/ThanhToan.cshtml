@model banthietbidientu.Models.ThanhToanViewModel

@{
    ViewData["Title"] = "Thanh toán - Electronic Store";
    decimal subtotal = Model.GioHangs.Sum(item => item.Price * item.Quantity);

    var tier = ViewBag.Tier as banthietbidientu.Services.MemberTier;
    decimal totalSpent = tier?.TotalSpent ?? 0;
    string rankName = tier?.Name ?? "Thành Viên";
    int phanTramGiam = tier?.DiscountPercent ?? 0;

    decimal soTienGiam = (subtotal * phanTramGiam) / 100;
    decimal tongThanhToan = subtotal - soTienGiam;
}

<link rel="stylesheet" href="~/css/leaflet.css" />

<style>
    .card {
        border-radius: 10px;
        transition: box-shadow 0.3s;
    }

        .card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

    .btn-check:checked + .btn-outline-primary {
        background-color: #0d6efd;
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    #map {
        height: 300px;
        width: 100%;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin-bottom: 15px;
        z-index: 1;
    }

    .delivery-option {
        transition: all 0.3s ease-in-out;
    }
</style>

<section class="container my-5">
    <h2 class="mb-4 text-center fw-bold">Thanh toán đơn hàng</h2>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <form asp-action="XacNhanThanhToan" asp-controller="GioHang" method="post" id="paymentForm">
        @Html.AntiForgeryToken()
        <input type="hidden" id="latInput" name="Latitude" />
        <input type="hidden" id="lngInput" name="Longitude" />
        <input type="hidden" name="TongTien" value="@tongThanhToan" />
        <input type="hidden" id="deliveryTypeInput" name="DeliveryType" value="Ship" />

        <input type="hidden" id="finalDiaChi" name="DiaChi" />
        <input type="hidden" id="finalTinhThanh" name="TinhThanh" />

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-2">
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="deliveryOptionBtn" id="btnShip" autocomplete="off" checked onclick="toggleDelivery('ship')">
                            <label class="btn btn-outline-primary fw-bold py-2" for="btnShip"><i class="bi bi-truck me-2"></i>Giao hàng tận nơi</label>

                            <input type="radio" class="btn-check" name="deliveryOptionBtn" id="btnStore" autocomplete="off" onclick="toggleDelivery('store')">
                            <label class="btn btn-outline-primary fw-bold py-2" for="btnStore"><i class="bi bi-shop me-2"></i>Nhận tại cửa hàng</label>
                        </div>
                    </div>
                </div>

                <div id="shippingSection" class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white"><h5 class="mb-0">Thông tin người nhận</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Họ và tên</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="NguoiNhan" value="@Model.TaiKhoan.FullName" required>
                                <span class="input-group-text bg-warning text-dark">@rankName</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Số điện thoại <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="SoDienThoai" value="@Model.TaiKhoan.PhoneNumber" placeholder="Nhập số điện thoại..." required>
                        </div>

                        <hr />
                        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-geo-alt-fill me-2"></i>Địa chỉ giao hàng</h6>

                        <div class="row mb-3">
                            <div class="col-md-4 mb-2">
                                <label class="form-label small fw-bold text-muted">Tỉnh / Thành phố</label>
                                <select id="province" class="form-select" required onchange="loadDistricts()">
                                    <option value="">Chọn Tỉnh/Thành</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label small fw-bold text-muted">Quận / Huyện</label>
                                <select id="district" class="form-select" required onchange="loadWards()">
                                    <option value="">Chọn Quận/Huyện</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label small fw-bold text-muted">Phường / Xã</label>
                                <select id="ward" class="form-select" required onchange="autoLocateOnMap()">
                                    <option value="">Chọn Phường/Xã</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Số nhà, Tên đường (Chi tiết)</label>
                            <input type="text" class="form-control" id="houseNumber"
                                   value="@Model.TaiKhoan.Address"
                                   placeholder="Ví dụ: Số 120 Xuân Thủy..." required onblur="autoLocateOnMap()">
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-primary">Ghim vị trí</label>
                            <div id="map"></div>
                            <div class="small text-muted"><i class="bi bi-info-circle"></i> Hệ thống sẽ tự động tính phí ship dựa trên vị trí bạn chọn.</div>
                        </div>
                    </div>
                </div>

                <div id="storeSection" class="card shadow-sm mb-4 d-none">
                    <div class="card-header bg-info text-white"><h5 class="mb-0">Chọn cửa hàng gần bạn</h5></div>
                    <div class="card-body">
                        <label class="form-label fw-bold">Danh sách chi nhánh:</label>
                        <select name="StoreId" class="form-select form-select-lg mb-3">
                            <option value="1">📍 Hà Nội: 120 Xuân Thủy, Cầu Giấy</option>
                            <option value="2">📍 Đà Nẵng: 78 Bạch Đằng, Hải Châu</option>
                            <option value="3">📍 TP.HCM: 55 Nguyễn Huệ, Quận 1</option>
                        </select>
                        <div class="alert alert-primary d-flex align-items-center" role="alert">
                            <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                            <div><strong>Miễn phí vận chuyển!</strong><br>Bạn sẽ đến cửa hàng để nhận máy. Vui lòng mang theo mã đơn hàng.</div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white"><h6 class="mb-0">Sản phẩm trong giỏ (@Model.GioHangs.Count)</h6></div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <tbody>
                                @foreach (var item in Model.GioHangs)
                                {
                                    <tr>
                                        <td class="ps-3"><img src="@(item.Image ?? "/image/logo.png")" class="rounded border" style="width: 50px;"></td>
                                        <td><div class="fw-bold small">@item.Name</div><div class="text-muted small">x @item.Quantity</div></td>
                                        <td class="text-end pe-3 small fw-bold">@((item.Price * item.Quantity).ToString("#,##0")) ₫</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-success text-white"><h4 class="mb-0">Thanh toán</h4></div>
                    <div class="card-body">
                        <h5 class="fw-bold mb-3 border-bottom pb-2">Chi tiết thanh toán</h5>
                        <div class="d-flex justify-content-between mb-2"><span class="text-muted">Tiền hàng:</span><span class="fw-bold">@subtotal.ToString("#,##0").Replace(",", ".") ₫</span></div>

                        @if (phanTramGiam > 0)
                        {
                            <div class="d-flex justify-content-between mb-2 text-danger"><span><i class="bi bi-ticket-perforated-fill me-1"></i>Ưu đãi @rankName (@phanTramGiam%):</span><span class="fw-bold">- @soTienGiam.ToString("#,##0").Replace(",", ".") ₫</span></div>
                        }

                        <div class="d-flex justify-content-between mb-2 text-success"><span><i class="bi bi-truck"></i> Phí vận chuyển:</span><span id="shippingFeeDisplay">0 ₫</span></div>
                        <div class="mb-3 small text-muted text-end fst-italic" id="warehouseDisplay">(Đang xác định vị trí...)</div>
                        <div class="d-flex justify-content-between border-top pt-3 mb-4"><span class="h5 fw-bold">Tổng cộng:</span><span class="h4 fw-bold text-danger" id="totalDisplay">@tongThanhToan.ToString("#,##0").Replace(",", ".") ₫</span></div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Hình thức thanh toán</label>
                            <div class="form-check mb-2 p-3 border rounded"><input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="COD" checked><label class="form-check-label fw-bold" for="cod"><i class="bi bi-cash-stack me-2 text-success"></i>Thanh toán khi nhận hàng (COD)</label></div>
                            <div class="form-check mb-2 p-3 border rounded bg-light"><input class="form-check-input" type="radio" name="paymentMethod" id="vnpay" value="VNPAY"><label class="form-check-label fw-bold text-primary" for="vnpay"><img src="https://cdn.haitrieu.com/wp-content/uploads/2022/10/Icon-VNPAY-QR.png" style="height: 20px; margin-right: 5px;"> VNPAY - Quét mã QR</label></div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" onclick="submitOrder()" class="btn btn-success btn-lg fw-bold shadow-sm"><i class="bi bi-check-circle me-2"></i> Đặt Hàng Ngay</button>
                            <a asp-action="Index" asp-controller="GioHang" class="btn btn-outline-secondary btn-sm">Quay lại giỏ hàng</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>

    <script>
        const shops = [
            { id: 1, name: 'Kho Hà Nội', lat: 21.0362, lng: 105.7829 },
            { id: 2, name: 'Kho Đà Nẵng', lat: 16.0718, lng: 108.2236 },
            { id: 3, name: 'Kho TP.HCM', lat: 10.7744, lng: 106.7035 }
        ];

        const subtotal = @(subtotal.ToString("0", System.Globalization.CultureInfo.InvariantCulture));
        let discountPercent = @(phanTramGiam) / 100.0;
        const shippingRate = 5000;
        let freeShipDistance = (discountPercent >= 0.25) ? 99999 : (@totalSpent >= 100000000 ? 99999 : (@totalSpent >= 50000000 ? 99999 : (@totalSpent >= 20000000 ? 300 : (@totalSpent >= 10000000 ? 15 : 0))));

        let currentLat = 21.0362, currentLng = 105.7829;
        var map = L.map('map').setView([21.0362, 105.7829], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
        var userMarker = L.marker([21.0362, 105.7829], {draggable: true}).addTo(map);

        userMarker.on('dragend', function (e) { var coord = e.target.getLatLng(); calculateShipping(coord.lat, coord.lng); });
        map.on('click', function(e) { userMarker.setLatLng(e.latlng); calculateShipping(e.latlng.lat, e.latlng.lng); });

        // --- API HÀNH CHÍNH VIỆT NAM ---
        var provinces = [];
        // Load Tỉnh/Thành
        fetch('https://provinces.open-api.vn/api/?depth=1')
            .then(response => response.json())
            .then(data => {
                provinces = data;
                let provinceSelect = document.getElementById('province');
                data.forEach(p => {
                    let option = document.createElement('option');
                    option.value = p.code;
                    option.text = p.name;
                    provinceSelect.add(option);
                });
            });

        function loadDistricts() {
            let provinceCode = document.getElementById('province').value;
            let districtSelect = document.getElementById('district');
            districtSelect.length = 1; // Reset
            document.getElementById('ward').length = 1; // Reset Ward

            if(provinceCode) {
                fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`)
                .then(response => response.json())
                .then(data => {
                    data.districts.forEach(d => {
                        let option = document.createElement('option');
                        option.value = d.code;
                        option.text = d.name;
                        districtSelect.add(option);
                    });
                    autoLocateOnMap(); // Thử tìm vị trí theo Tỉnh
                });
            }
        }

        function loadWards() {
            let districtCode = document.getElementById('district').value;
            let wardSelect = document.getElementById('ward');
            wardSelect.length = 1;

            if(districtCode) {
                fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`)
                .then(response => response.json())
                .then(data => {
                    data.wards.forEach(w => {
                        let option = document.createElement('option');
                        option.value = w.name; // Lưu tên phường để dễ search
                        option.text = w.name;
                        wardSelect.add(option);
                    });
                    autoLocateOnMap(); // Tìm vị trí theo Huyện
                });
            }
        }

        // --- AUTO LOCATE (TỰ ĐỘNG TÌM TRÊN MAP) ---
        function autoLocateOnMap() {
            let p = document.getElementById('province').options[document.getElementById('province').selectedIndex].text;
            let d = document.getElementById('district').options[document.getElementById('district').selectedIndex].text;
            let w = document.getElementById('ward').value;
            let street = document.getElementById('houseNumber').value;

            if(p == "Chọn Tỉnh/Thành") return;

            // Tạo chuỗi địa chỉ để search
            let addressQuery = "";
            if(street) addressQuery += street + ", ";
            if(w) addressQuery += w + ", ";
            if(d != "Chọn Quận/Huyện") addressQuery += d + ", ";
            addressQuery += p + ", Vietnam";

            // Gọi Nominatim API (OpenStreetMap Search)
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addressQuery)}&limit=1`)
            .then(res => res.json())
            .then(data => {
                if(data && data.length > 0) {
                    let lat = parseFloat(data[0].lat);
                    let lon = parseFloat(data[0].lon);

                    // Di chuyển Map và Marker
                    map.setView([lat, lon], 15);
                    userMarker.setLatLng([lat, lon]);

                    // Tính ship ngay lập tức
                    calculateShipping(lat, lon);
                }
            })
            .catch(err => console.log("Không tìm thấy địa chỉ trên bản đồ"));
        }

        // --- LOGIC TÍNH SHIP (Giữ nguyên) ---
        function calculateShipping(lat, lng) {
            currentLat = lat; currentLng = lng;
            let minDistance = Infinity; let nearestShop = null;

            shops.forEach(shop => {
                let dist = getDistance(lat, lng, shop.lat, shop.lng);
                if (dist < minDistance) { minDistance = dist; nearestShop = shop; }
            });

            let km = Math.round(minDistance * 10) / 10;
            let fee = 0;
            if (km > freeShipDistance) {
                let chargeableKm = (freeShipDistance > 0) ? (km - freeShipDistance) : km;
                if(freeShipDistance === 0 && km <= 5) chargeableKm = 0;
                fee = Math.round(chargeableKm * shippingRate);
            }

            document.getElementById('warehouseDisplay').innerHTML = `Vận chuyển từ: <strong>${nearestShop.name}</strong> (${km} km)`;
            document.getElementById('shippingFeeDisplay').innerText = fee === 0 ? 'Miễn phí' : fee.toLocaleString('vi-VN') + ' ₫';
            updateTotalDisplay(fee);
            document.getElementById('latInput').value = lat; document.getElementById('lngInput').value = lng;
        }

        function updateTotalDisplay(shipFee) {
            let discountAmount = Math.round(subtotal * discountPercent);
            let total = subtotal - discountAmount + shipFee;
            document.getElementById('totalDisplay').innerText = total.toLocaleString('vi-VN') + ' ₫';
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2 - lat1); var dLon = deg2rad(lon2 - lon1);
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }

        function toggleDelivery(type) {
            if (type === 'store') {
                document.getElementById('shippingSection').classList.add('d-none');
                document.getElementById('storeSection').classList.remove('d-none');
                document.getElementById('deliveryTypeInput').value = 'Store';
                updateTotalDisplay(0);
            } else {
                document.getElementById('shippingSection').classList.remove('d-none');
                document.getElementById('storeSection').classList.add('d-none');
                document.getElementById('deliveryTypeInput').value = 'Ship';
                calculateShipping(currentLat, currentLng);
            }
        }

        // Gộp dữ liệu trước khi Submit
        function submitOrder() {
            let p = document.getElementById('province').options[document.getElementById('province').selectedIndex]?.text;
            let d = document.getElementById('district').options[document.getElementById('district').selectedIndex]?.text;
            let w = document.getElementById('ward').value;
            let street = document.getElementById('houseNumber').value;
            let deliveryType = document.getElementById('deliveryTypeInput').value;

            if(deliveryType === 'Ship') {
                if (!p || p === "Chọn Tỉnh/Thành" || !d || !w || !street) {
                    alert("Vui lòng chọn đầy đủ địa chỉ giao hàng!");
                    return;
                }
                // Gán dữ liệu vào input ẩn để gửi về Controller
                document.getElementById('finalTinhThanh').value = p;
                document.getElementById('finalDiaChi').value = `${street}, ${w}, ${d}`;
            }

            document.getElementById('paymentForm').submit();
        }
    </script>
}