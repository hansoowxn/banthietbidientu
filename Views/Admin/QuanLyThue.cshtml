@model IEnumerable<banthietbidientu.Models.DonHang>
@{
    ViewData["Title"] = "Báo cáo Thuế & Doanh thu ròng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var cultureInfo = new System.Globalization.CultureInfo("vi-VN");
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold text-primary"><i class="bi bi-bank me-2"></i>Báo Cáo & Kiểm Soát Thuế (VAT)</h4>

        <form method="get" class="d-flex gap-2">
            <select name="month" class="form-select form-select-sm" style="width: 120px;">
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i" selected="@(ViewBag.SelectedMonth == i)">Tháng @i</option>
                }
            </select>
            <select name="year" class="form-select form-select-sm" style="width: 100px;">
                @for (int i = DateTime.Now.Year; i >= 2023; i--)
                {
                    <option value="@i" selected="@(ViewBag.SelectedYear == i)">@i</option>
                }
            </select>
            <button type="submit" class="btn btn-primary btn-sm fw-bold"><i class="bi bi-filter"></i> Xem Báo Cáo</button>
        </form>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-white bg-opacity-25 rounded-circle p-2 me-3">
                            <i class="bi bi-cash-stack fs-4"></i>
                        </div>
                        <h6 class="mb-0 text-uppercase opacity-75 fw-bold">Doanh Thu Thực (Net)</h6>
                    </div>
                    <h3 class="fw-bold mb-0">@(((decimal)ViewBag.DoanhThuNet).ToString("N0", cultureInfo)) ₫</h3>
                    <small class="opacity-75">Tiền thực nhận (Đã trừ thuế)</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 bg-danger text-white h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-white bg-opacity-25 rounded-circle p-2 me-3">
                            <i class="bi bi-building fs-4"></i>
                        </div>
                        <h6 class="mb-0 text-uppercase opacity-75 fw-bold">Thuế Phải Nộp (Tháng)</h6>
                    </div>
                    <h3 class="fw-bold mb-0">@(((decimal)ViewBag.ThueThang).ToString("N0", cultureInfo)) ₫</h3>
                    <small class="opacity-75">Nghĩa vụ thuế tháng @ViewBag.SelectedMonth</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 bg-white border h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-light rounded-circle p-2 me-3 text-secondary">
                            <i class="bi bi-piggy-bank fs-4"></i>
                        </div>
                        <h6 class="mb-0 text-uppercase text-muted fw-bold">Tổng Thuế (Lũy kế)</h6>
                    </div>
                    <h3 class="fw-bold mb-0 text-dark">@(((decimal)ViewBag.TongThueAll).ToString("N0", cultureInfo)) ₫</h3>
                    <small class="text-muted">Tổng thuế đã thu từ trước đến nay</small>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
            <h6 class="fw-bold m-0 text-secondary"><i class="bi bi-list-task me-2"></i>Chi tiết đơn hàng phát sinh thuế</h6>

            <a asp-action="XuatExcelThue" asp-route-month="@ViewBag.SelectedMonth" asp-route-year="@ViewBag.SelectedYear" class="btn btn-outline-success btn-sm">
                <i class="bi bi-file-earmark-excel me-1"></i> Xuất Excel
            </a>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Mã đơn</th>
                            <th>Ngày hóa đơn</th>
                            <th class="text-end">Tổng thanh toán</th>
                            <th class="text-end text-danger">Thuế VAT (10%)</th>
                            <th class="text-end text-success">Doanh thu Net</th>
                            <th class="text-center">Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            foreach (var item in Model)
                            {
                                // Tính lại Net cho từng dòng để hiển thị (Net = Tổng - Thuế)
                                decimal net = item.TongTien - item.TienThue;
                                <tr>
                                    <td class="ps-4 fw-bold text-primary">#@item.MaDon</td>
                                    <td>@item.NgayDat.Value.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td class="text-end fw-bold">@item.TongTien.ToString("N0") ₫</td>
                                    <td class="text-end text-danger fw-bold">@item.TienThue.ToString("N0") ₫</td>
                                    <td class="text-end text-success fw-bold">@net.ToString("N0") ₫</td>
                                    <td class="text-center">
                                        <span class="badge bg-success bg-opacity-10 text-success border border-success px-3">Đã xuất HD</span>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-3 opacity-50"></i>
                                    Không có phát sinh thuế trong tháng này.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white border-0 py-3">
            <small class="text-muted fst-italic">* Số liệu chỉ tính trên các đơn hàng đã hoàn thành (Giao thành công).</small>
        </div>
    </div>
</div>