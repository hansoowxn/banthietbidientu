@model IEnumerable<banthietbidientu.Models.DonHangViewModel>

@{
    ViewData["Title"] = "Quản lý đơn hàng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
}

<style>
    /* --- HIỆU ỨNG HIGHLIGHT --- */
    @@keyframes flash-animation {
        0% {
            background-color: #ff4757;
            color: white;
        }

        25% {
            background-color: #ff6b81;
            color: white;
        }

        50% {
            background-color: #ffa502;
            color: black;
        }

        75% {
            background-color: #fff200;
            color: black;
        }

        100% {
            background-color: transparent;
            color: inherit;
        }
    }

    .row-highlight {
        animation: flash-animation 6s ease-out forwards;
    }

        .row-highlight a, .row-highlight .badge, .row-highlight select {
            color: inherit !important;
            border-color: currentColor !important;
        }

    /* Style cho select trạng thái gọn gàng */
    .status-select {
        border: 1px solid #dee2e6;
        border-radius: 20px;
        padding: 4px 12px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        background-color: #fff;
        width: 140px;
    }

        .status-select:focus {
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
            border-color: #0d6efd;
        }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary"><i class="bi bi-receipt me-2"></i>Quản lý Đơn hàng</h2>
    </div>

    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="ps-4">Mã đơn</th>
                            <th>Khách hàng</th>
                            <th>Ngày đặt</th>
                            <th>Tổng giá trị</th>
                            <th>Trạng thái</th>
                            <th>Thực thu</th>
                            <th class="text-end pe-4">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            // Tính tổng tiền hàng gốc (để so sánh với Thực thu)
                            decimal originalTotal = item.SanPhams.Sum(x => (x.Gia ?? 0) * x.SoLuong);
                            bool isFinalState = (item.TrangThai == "Hoàn thành" || item.TrangThai == "Đã hủy");

                            <tr id="row-@item.MaDon" class="data-row">
                                <td class="ps-4 fw-bold text-primary">#@item.MaDon</td>

                                <td>
                                    <div class="fw-bold text-dark">@item.TenKhachHang</div>
                                    <div class="small text-muted">@item.SanPhams.Count sản phẩm</div>
                                </td>

                                <td class="text-muted small">
                                    @(item.NgayDat.HasValue ? item.NgayDat.Value.ToString("dd/MM/yyyy HH:mm") : "")
                                </td>

                                <td class="text-muted fw-medium">
                                    @originalTotal.ToString("#,##0") đ
                                </td>

                                <td>
                                    @if (isFinalState)
                                    {
                                        // Nếu đã xong/hủy -> Chỉ hiện Badge, không cho sửa
                                        if (item.TrangThai == "Hoàn thành")
                                        {
                                            <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">
                                                <i class="bi bi-check-circle-fill me-1"></i> Hoàn thành
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger bg-opacity-10 text-danger px-3 py-2 rounded-pill">
                                                <i class="bi bi-x-circle-fill me-1"></i> Đã hủy
                                            </span>
                                        }
                                    }
                                    else
                                    {
                                        // Nếu đang chạy -> Hiện Dropdown
                                        <select class="form-select form-select-sm status-select
                                                @(item.TrangThai == "Chờ xử lý" ? "text-warning border-warning" :
                                                  item.TrangThai == "Đã xác nhận" ? "text-info border-info" : "text-primary border-primary")"
                                                onchange="updateStatus('@item.MaDon', this.value)">

                                            <option value="Chờ xử lý" selected="@(item.TrangThai == "Chờ xử lý")">Chờ xử lý</option>
                                            <option value="Đã xác nhận" selected="@(item.TrangThai == "Đã xác nhận")">Đã xác nhận</option>
                                            <option value="Đang giao" selected="@(item.TrangThai == "Đang giao")">Đang giao</option>
                                            <option value="Hoàn thành">Hoàn thành</option>
                                            <option value="Đã hủy">Hủy đơn</option>
                                        </select>
                                    }
                                </td>

                                <td>
                                    <span class="fw-bold text-danger">@item.TongTien.ToString("#,##0") đ</span>
                                    @if (originalTotal > item.TongTien)
                                    {
                                        <div class="small text-success fst-italic">(-@((originalTotal - item.TongTien).ToString("#,##0")))</div>
                                    }
                                </td>

                                <td class="text-end pe-4">
                                    <a href="@Url.Action("InHoaDon", "Admin", new { orderId = item.MaDon })"
                                       target="_blank"
                                       class="btn btn-sm btn-outline-secondary"
                                       title="In hóa đơn">
                                        <i class="bi bi-printer"></i>
                                    </a>

                                    <button class="btn btn-sm btn-outline-primary ms-1"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#detail-@item.MaDon">
                                        <i class="bi bi-chevron-down"></i>
                                    </button>
                                </td>
                            </tr>

                            <tr class="collapse bg-light" id="detail-@item.MaDon">
                                <td colspan="7" class="p-4">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="fw-bold text-primary mb-3">Chi tiết sản phẩm</h6>
                                            <ul class="list-group mb-3">
                                                @foreach (var sp in item.SanPhams)
                                                {
                                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                                                        <div class="d-flex align-items-center">
                                                            <img src="@(sp.HinhAnh ?? "/image/logo.png")" class="rounded border me-3" style="width: 40px; height: 40px; object-fit: cover;">
                                                            <div>
                                                                <div class="fw-bold small">@sp.TenSanPham</div>
                                                                <div class="text-muted small">x @sp.SoLuong</div>
                                                            </div>
                                                        </div>
                                                        <span class="fw-bold small">@((sp.Gia ?? 0).ToString("#,##0")) đ</span>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                        <div class="col-md-4 border-start">
                                            <h6 class="fw-bold text-secondary mb-3">Thông tin giao hàng</h6>
                                            <p class="small mb-1"><i class="bi bi-person me-2"></i>@item.TenKhachHang</p>
                                            <p class="small mb-1"><i class="bi bi-telephone me-2"></i>@(item.SoDienThoai ?? "Chưa cập nhật")</p>
                                            <p class="small mb-1"><i class="bi bi-geo-alt me-2"></i>@(item.DiaChiGiaoHang ?? "Nhận tại cửa hàng")</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                @if (!Model.Any())
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox text-muted opacity-25" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">Chưa có đơn hàng nào.</p>
                    </div>
                }
            </div>

            @if (totalPages > 1)
            {
                <div class="d-flex justify-content-center py-3 border-top">
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            @for (int i = 1; i <= totalPages; i++)
                            {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("QuanLyDonHang", new { page = i })">@i</a>
                                </li>
                            }
                        </ul>
                    </nav>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const params = new URLSearchParams(window.location.search);
            const highlightId = params.get('highlightId');

            if (highlightId) {
                const row = document.getElementById('row-' + highlightId);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    row.classList.add('row-highlight');

                    const detailBtn = row.querySelector('[data-bs-toggle="collapse"]');
                    if(detailBtn) detailBtn.click();

                    setTimeout(() => {
                        row.classList.remove('row-highlight');
                    }, 6000);
                }
            }
        });

        // Hàm cập nhật trạng thái
        function updateStatus(orderId, newStatus) {
            // Xác nhận trước khi đổi
            if(!confirm('Bạn có chắc muốn đổi trạng thái đơn ' + orderId + ' sang: ' + newStatus + '?')) {
                location.reload(); // Reload để trả lại giá trị cũ nếu hủy
                return;
            }

            fetch('/Admin/CapNhatTrangThai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `orderId=${orderId}&status=${newStatus}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Không cần alert phiền phức, reload để cập nhật giao diện (khóa select nếu hoàn thành)
                    location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Lỗi kết nối server!');
            });
        }
    </script>
}