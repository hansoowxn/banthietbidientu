@inject banthietbidientu.Services.MemberService MemberService

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - SmartTech</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/leaflet.css" asp-append-version="true" />

    <script src="~/js/leaflet.js" asp-append-version="true"></script>

    @RenderSection("Styles", required: false)

    <style>
        /* CSS Admin Link */
        .admin-link a {
            color: #dc3545 !important;
            font-weight: 700 !important;
        }

            .admin-link a:hover {
                background-color: #fff5f5;
                border-radius: 4px;
            }

        body {
            margin: 0;
            font-family: 'Be Vietnam Pro', Arial, sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header Styles */
        .smarttech-header {
            z-index: 1020 !important;
            position: fixed;
            top: 0;
            width: 100%;
            background-color: #0d6efd;
        }

        .dropdown-menu {
            z-index: 1021 !important;
            border: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-radius: 8px;
        }

        .main-content {
            padding: 20px;
            padding-top: 140px;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        .btn-dropdown-custom {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white !important;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            padding: 0.75rem 1.5rem;
        }

        .header-brand {
            flex-shrink: 0;
        }

        /* Search Bar */
        .header-search-wrapper {
            flex-grow: 1;
            max-width: 600px;
            position: relative;
        }

        .header-search-form {
            display: flex;
            width: 100%;
            border-radius: 50px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2);
            background: white;
            transition: all 0.3s;
        }

            .header-search-form:focus-within {
                box-shadow: 0 0 0 4px rgba(255,255,255,0.2);
                border-color: white;
            }

            .header-search-form .form-control {
                border: none;
                box-shadow: none;
                padding-left: 20px;
                font-size: 0.95rem;
            }

            .header-search-form .btn-search {
                background-color: white;
                border: none;
                color: #0d6efd;
                padding-right: 20px;
                transition: 0.2s;
            }

                .header-search-form .btn-search:hover {
                    color: #0a58ca;
                    transform: scale(1.1);
                }

        /* Live Search Results */
        #searchResults {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            margin-top: 8px;
            display: none;
            overflow: hidden;
            z-index: 1030;
        }

        .search-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            text-decoration: none;
            color: #333;
            transition: 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

            .search-item:last-child {
                border-bottom: none;
            }

            .search-item:hover {
                background-color: #f8f9fa;
            }

            .search-item img {
                width: 40px;
                height: 40px;
                object-fit: cover;
                border-radius: 6px;
                margin-right: 12px;
                border: 1px solid #eee;
            }

        .search-item-info h6 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: #212529;
        }

        .search-item-info span {
            font-size: 0.8rem;
            color: #dc3545;
            font-weight: 700;
        }

        /* Trade-in Button */
        .btn-trade-in {
            background: linear-gradient(135deg, #FF8008 0%, #FFC837 100%);
            border: none;
            color: #fff;
            font-weight: 700;
            padding: 6px 18px;
            border-radius: 50px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(255, 128, 8, 0.3);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

            .btn-trade-in:hover {
                background: linear-gradient(135deg, #FFC837 0%, #FF8008 100%);
                transform: translateY(-2px);
                box-shadow: 0 6px 15px rgba(255, 128, 8, 0.4);
                color: white;
            }

            .btn-trade-in i {
                font-size: 1.1rem;
                margin-right: 5px;
            }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            flex-shrink: 0;
            align-items: center;
        }

            .header-actions .btn-outline-light {
                border: 1px solid rgba(255,255,255,0.3);
                font-weight: 500;
            }

                .header-actions .btn-outline-light:hover {
                    background: rgba(255,255,255,0.1);
                    border-color: white;
                }

        .header-nav {
            background-color: #ffffff;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }

        .header-nav-list {
            display: flex;
            justify-content: center;
            gap: 2.5rem;
            list-style: none;
            padding: 0.75rem 0;
            margin: 0;
            overflow-x: auto;
        }

            .header-nav-list li a {
                text-decoration: none;
                color: #333;
                font-weight: 600;
                white-space: nowrap;
                transition: color 0.2s;
            }

                .header-nav-list li a:hover {
                    color: #0d6efd;
                }

        @@media (max-width: 991.98px) {
            .header-top {
                flex-wrap: wrap;
            }

            .header-search-wrapper {
                order: 3;
                width: 100%;
                max-width: none;
                margin-top: 0.5rem;
            }

            .main-content {
                padding-top: 190px;
            }

            .header-nav-list {
                justify-content: flex-start;
                gap: 1.5rem;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
        }

        .leaflet-control-attribution {
            display: none !important;
        }

        .site-footer {
            background-color: #212529;
            color: #adb5bd;
            font-size: 0.9rem;
            padding-top: 3rem;
            margin-top: auto;
        }

            .site-footer h5 {
                color: #fff;
                font-weight: 700;
                margin-bottom: 1.2rem;
                font-size: 1.1rem;
                text-transform: uppercase;
            }

            .site-footer ul li {
                margin-bottom: 0.5rem;
            }

            .site-footer a {
                color: #adb5bd;
                text-decoration: none;
                transition: all 0.2s;
            }

                .site-footer a:hover {
                    color: #fff;
                    text-decoration: underline;
                }

        .footer-social-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 50%;
            margin-right: 10px;
            color: #fff;
            transition: 0.3s;
        }

            .footer-social-icon:hover {
                background-color: #0d6efd;
                transform: translateY(-3px);
            }

        .footer-bottom {
            background-color: #1a1d20;
            padding: 1.5rem 0;
            margin-top: 2rem;
            border-top: 1px solid #343a40;
        }
    </style>
</head>
<body>

    <header class="smarttech-header bg-primary text-white fixed-top shadow-sm" style="z-index: 1020;">
        <div class="header-top container-fluid">
            <a class="navbar-brand fw-bold d-flex align-items-center header-brand text-white" href="/">
                <img src="~/image/logo.png" alt="SmartTech Logo" style="height: 30px; margin-right: 10px;">
                SmartTech
            </a>

            <div class="header-search-wrapper">
                <form class="header-search-form" asp-controller="Home" asp-action="Index" method="get" autocomplete="off">
                    <input id="searchInput" class="form-control form-control-lg" name="search" placeholder="Bạn tìm gì hôm nay?" value="@ViewData["SearchQuery"]">
                    <button type="submit" class="btn btn-search btn-lg"><i class="bi bi-search"></i></button>
                </form>
                <div id="searchResults"></div>
            </div>

            <div class="header-actions">
                <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#locationModal">
                    <i class="bi bi-geo-alt-fill"></i><span>Xem vị trí</span>
                </button>

                <a asp-controller="GioHang" asp-action="Index" class="btn btn-outline-light">
                    <i class="bi bi-cart-fill"></i><span>Giỏ Hàng</span>
                </a>

                @if (User.Identity.IsAuthenticated)
                {
                    var currentTier = MemberService.GetUserTier(User.Identity.Name);
                    <div class="dropdown">
                        <button class="btn dropdown-toggle d-flex align-items-center gap-2 shadow-sm @currentTier.CssClass" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="transition: all 0.3s; border: 1px solid rgba(255,255,255,0.5);">
                            <i class="bi @currentTier.Icon fs-5"></i>
                            <div class="d-flex flex-column text-start" style="line-height: 1.1;">
                                <span style="font-size: 0.9rem;">@User.Identity.Name</span>
                                <span style="font-size: 0.65rem; opacity: 0.9; text-transform: uppercase;">@currentTier.Name</span>
                            </div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2" aria-labelledby="userDropdown">
                            <li class="px-3 py-2 text-center bg-light border-bottom">
                                <div class="small text-muted">Hạng thành viên</div>
                                <div class="fw-bold text-primary text-uppercase">@currentTier.Name</div>
                                @if (currentTier.CssClass != "tier-boss" && currentTier.CssClass != "tier-admin")
                                {
                                    <div class="progress mt-2" style="height: 4px;">
                                        @{
                                            decimal maxLevel = 100000000;
                                            var percent = (int)((currentTier.TotalSpent / maxLevel) * 100);
                                            if (percent > 100) percent = 100;
                                        }
                                        <div class="progress-bar bg-success" role="progressbar" style="width: @percent%"></div>
                                    </div>
                                    <small class="text-muted" style="font-size: 10px;">Chi tiêu: @currentTier.TotalSpent.ToString("#,##0") đ</small>
                                }
                            </li>
                            @if (User.IsInRole("Admin") || User.IsInRole("Boss"))
                            {
                                <li><a class="dropdown-item text-danger fw-bold py-2" asp-controller="Admin" asp-action="Index"><i class="bi bi-speedometer2 me-2"></i> Trang quản trị</a></li>
                                <li><hr class="dropdown-divider"></li>
                            }
                            <li><a class="dropdown-item py-2" asp-controller="Login" asp-action="Profile"><i class="bi bi-person-badge me-2"></i> Hồ sơ của tôi</a></li>
                            <li><a class="dropdown-item py-2" asp-controller="Login" asp-action="LichSuMuaHang"><i class="bi bi-bag-check me-2"></i> Lịch sử mua hàng</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form asp-controller="Login" asp-action="Logout" method="post" style="margin:0;">
                                    <button type="submit" class="dropdown-item text-danger py-2"><i class="bi bi-box-arrow-right me-2"></i> Đăng xuất</button>
                                </form>
                            </li>
                        </ul>
                    </div>
                }
                else
                {
                    <a class="btn btn-outline-light" asp-controller="Login" asp-action="DangNhap">
                        <i class="bi bi-person-circle"></i><span>Đăng nhập</span>
                    </a>
                }
            </div>
        </div>

        <nav class="header-nav">
            <ul class="header-nav-list container-fluid">
                <li><a asp-controller="Home" asp-action="Index" asp-route-category="">Tất cả sản phẩm</a></li>
                <li><a asp-controller="Home" asp-action="Index" asp-route-category="Điện thoại">Điện thoại</a></li>
                <li><a asp-controller="Home" asp-action="Index" asp-route-category="Laptop">Laptop</a></li>
                <li><a asp-controller="Home" asp-action="Index" asp-route-category="Tablet">Tablet</a></li>
                <li><a asp-controller="Home" asp-action="Index" asp-route-category="Smartwatch">Smartwatch</a></li>
                <li><a asp-controller="Home" asp-action="Index" asp-route-category="Phụ kiện">Phụ kiện</a></li>
                <li class="nav-item ms-lg-2 mt-2 mt-lg-0 d-flex align-items-center">
                    <a class="btn-trade-in" asp-controller="Home" asp-action="ThuMuaMayCu">
                        <i class="bi bi-recycle"></i> Thu cũ đổi mới
                    </a>
                </li>
            </ul>
        </nav>
    </header>

    <div class="main-content">
        @RenderBody()
    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 99999; margin-top: 80px;">
        @if (TempData["Success"] != null)
        {
            <div class="toast align-items-center text-white bg-success border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle-fill me-2"></i> @TempData["Success"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="toast align-items-center text-white bg-danger border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["Error"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        }
    </div>

    <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationModalLabel"><i class="bi bi-shop"></i> Hệ thống cửa hàng SmartTech</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">Chọn cửa hàng để xem trên bản đồ:</p>
                    <div class="row">
                        <div class="col-lg-5 col-md-12">
                            <div class="list-group list-group-flush mb-3">
                                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="panToMap(event, 21.0362, 105.7829)">
                                    <div><strong class="d-block text-primary">Hà Nội <i class="bi bi-chevron-right ms-2"></i></strong>120 Xuân Thủy, P. Dịch Vọng Hậu, Cầu Giấy</div>
                                    <button class="btn btn-sm btn-outline-primary" title="Chỉ đường" onclick="event.stopPropagation(); getDirections(21.0362, 105.7829)"><i class="bi bi-signpost-fill"></i></button>
                                </a>
                                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="panToMap(event, 16.0718, 108.2236)">
                                    <div><strong class="d-block text-primary">Đà Nẵng <i class="bi bi-chevron-right ms-2"></i></strong>78 Bạch Đằng, P. Hải Châu I, Hải Châu</div>
                                    <button class="btn btn-sm btn-outline-primary" title="Chỉ đường" onclick="event.stopPropagation(); getDirections(16.0718, 108.2236)"><i class="bi bi-signpost-fill"></i></button>
                                </a>
                                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="panToMap(event, 10.7744, 106.7035)">
                                    <div><strong class="d-block text-primary">TP. Hồ Chí Minh <i class="bi bi-chevron-right ms-2"></i></strong>55 Nguyễn Huệ, P. Bến Nghé, Quận 1</div>
                                    <button class="btn btn-sm btn-outline-primary" title="Chỉ đường" onclick="event.stopPropagation(); getDirections(10.7744, 106.7035)"><i class="bi bi-signpost-fill"></i></button>
                                </a>
                            </div>
                            <button type="button" class="btn btn-primary w-100 mb-2" onclick="findUserLocation()"><i class="bi bi-crosshair me-2"></i> Vị trí của tôi</button>
                            <p id="location-status" class="text-center small text-secondary"></p>
                        </div>
                        <div class="col-lg-7 col-md-12"><div id="map" style="height: 350px; border-radius: 8px; border: 1px solid #ccc;"></div></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <div class="container">
            <div class="row gy-4">
                <div class="col-lg-4 col-md-6">
                    <h5 class="d-flex align-items-center"><img src="~/image/logo.png" alt="SmartTech" style="height: 30px; margin-right: 10px; filter: brightness(0) invert(1);"> SmartTech</h5>
                    <p class="text-muted mt-3">Hệ thống bán lẻ điện thoại, máy tính, phụ kiện công nghệ chính hãng uy tín hàng đầu Việt Nam.</p>
                    <ul class="list-unstyled text-muted">
                        <li><i class="bi bi-geo-alt-fill me-2 text-primary"></i> 120 Xuân Thủy, Cầu Giấy, Hà Nội</li>
                        <li><i class="bi bi-telephone-fill me-2 text-primary"></i> 0965.629.698 (8:00 - 21:30)</li>
                        <li><i class="bi bi-envelope-fill me-2 text-primary"></i> vuduc792@gmail.com</li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6"><h5>Chính sách</h5><ul class="list-unstyled"><li><a href="#">Chính sách bảo hành</a></li><li><a href="#">Chính sách đổi trả</a></li><li><a href="#">Chính sách bảo mật</a></li><li><a href="#">Hướng dẫn mua hàng</a></li><li><a href="#">Kiểm tra đơn hàng</a></li></ul></div>
                <div class="col-lg-2 col-md-6"><h5>Về SmartTech</h5><ul class="list-unstyled"><li><a href="#">Giới thiệu công ty</a></li><li><a href="#">Tuyển dụng</a></li><li><a href="#">Hệ thống cửa hàng</a></li><li><a href="#">Tin tức công nghệ</a></li><li><a href="#">Liên hệ hợp tác</a></li></ul></div>
                <div class="col-lg-4 col-md-6"><h5>Kết nối với chúng tôi</h5><p class="text-muted mb-3">Theo dõi SmartTech để nhận thông tin khuyến mãi mới nhất.</p><div class="d-flex gap-2"><a href="https://facebook.com" class="footer-social-icon" title="Facebook"><i class="bi bi-facebook"></i></a><a href="https://youtube.com" class="footer-social-icon" title="Youtube"><i class="bi bi-youtube"></i></a><a href="https://instagram.com" class="footer-social-icon" title="Instagram"><i class="bi bi-instagram"></i></a><a href="https://tiktok.com" class="footer-social-icon" title="Tiktok"><i class="bi bi-tiktok"></i></a></div><div class="mt-4"><h6 class="text-white">Thanh toán miễn phí</h6><div class="d-flex gap-2 text-white fs-4"><i class="bi bi-credit-card-2-front"></i><i class="bi bi-qr-code-scan"></i><i class="bi bi-cash-coin"></i></div></div></div>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="container d-flex flex-wrap justify-content-between align-items-center">
                <div class="text-white-50 small">© @DateTime.Now.Year SmartTech Corporation. All rights reserved.</div>
                <div class="d-flex gap-3 small"><a asp-controller="Home" asp-action="Terms">Điều khoản sử dụng</a><a asp-controller="Home" asp-action="Privacy">Chính sách quyền riêng tư</a></div>
            </div>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        var mapid; var storeMarkers = []; var userMarker;
        const stores = [{ name: 'Hà Nội', lat: 21.0362, lng: 105.7829, address: '120 Xuân Thủy, Cầu Giấy' }, { name: 'Đà Nẵng', lat: 16.0718, lng: 108.2236, address: '78 Bạch Đằng, Hải Châu I' }, { name: 'TP.HCM', lat: 10.7744, lng: 106.7035, address: '55 Nguyễn Huệ, Quận 1' }];
        let storeLogoIcon, userIcon;
        if (typeof L !== 'undefined') {
            storeLogoIcon = L.icon({ iconUrl: '/image/logo.png', iconSize: [35, 35], iconAnchor: [17, 35], popupAnchor: [0, -35] });
            userIcon = L.divIcon({ className: 'custom-div-icon', html: '<i class="bi bi-geo-alt-fill text-danger" style="font-size: 2rem;"></i>', iconSize: [32, 32], iconAnchor: [16, 32] });
        }
        document.addEventListener('DOMContentLoaded', function () {
            const locationModal = document.getElementById('locationModal');
            if (locationModal) {
                locationModal.addEventListener('shown.bs.modal', function () {
                    initLeafletMap();
                    if (mapid) { setTimeout(function () { mapid.invalidateSize(); mapid.setView([stores[0].lat, stores[0].lng], 12); }, 300); }
                });
            }

            // [MỚI] Tự động ẩn Toast sau 3 giây
            var toasts = document.querySelectorAll('.toast');
            toasts.forEach(function(toastNode) {
                var toast = new bootstrap.Toast(toastNode, { delay: 3000 });
                toast.show();
            });
        });

        function initLeafletMap() {
            if (mapid) return;
            if (typeof L === 'undefined') return;
            try {
                const hanoi = { lat: stores[0].lat, lng: stores[0].lng };
                mapid = L.map('map').setView([hanoi.lat, hanoi.lng], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(mapid);
                stores.forEach(store => { const marker = L.marker([store.lat, store.lng], { icon: storeLogoIcon }).addTo(mapid); marker.bindPopup(`<strong>${store.name}</strong><br>${store.address}`); storeMarkers.push(marker); });
            } catch (error) { console.error(error); }
        }
        function panToMap(event, lat, lng) { event.preventDefault(); if (!mapid) return; mapid.setView([lat, lng], 15); const markerToOpen = storeMarkers.find(marker => { const pos = marker.getLatLng(); return pos.lat === lat && pos.lng === lng; }); if (markerToOpen) markerToOpen.openPopup(); }
        function findUserLocation() { const statusElement = document.getElementById('location-status'); if (!mapid) return; if (navigator.geolocation) { statusElement.innerText = "Đang tìm..."; navigator.geolocation.getCurrentPosition((position) => { const lat = position.coords.latitude; const lng = position.coords.longitude; statusElement.innerText = ""; if (userMarker) mapid.removeLayer(userMarker); userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(mapid).bindPopup("Vị trí của bạn").openPopup(); mapid.setView([lat, lng], 14); L.circle([lat, lng], { radius: position.coords.accuracy, color: 'blue', fillOpacity: 0.1, weight: 1 }).addTo(mapid); }, (error) => { alert("Không thể lấy vị trí."); statusElement.innerText = ""; }); } else { alert("Trình duyệt không hỗ trợ Geolocation."); } }
        function getDirections(lat, lng) { const destination = `${lat},${lng}`; const url = `https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`; window.open(url, '_blank'); }

        // Live Search
        $(document).ready(function () {
            let debounceTimer;
            $('#searchInput').on('keyup', function () {
                const query = $(this).val().trim();
                const resultsContainer = $('#searchResults');
                clearTimeout(debounceTimer);
                if (query.length < 1) { resultsContainer.hide(); return; }
                debounceTimer = setTimeout(function () {
                    $.ajax({
                        url: '/Home/SearchLive', type: 'GET', data: { query: query },
                        success: function (data) {
                            resultsContainer.empty();
                            if (data.length > 0) {
                                data.forEach(product => { const price = product.price.toLocaleString('vi-VN') + ' đ'; const item = `<a href="/Home/ChiTietSanPham/${product.id}" class="search-item"><img src="${product.image}" alt="${product.name}"><div class="search-item-info"><h6>${product.name}</h6><span>${price}</span></div></a>`; resultsContainer.append(item); });
                                resultsContainer.show();
                            } else { resultsContainer.append('<div class="p-3 text-muted text-center">Không tìm thấy sản phẩm nào.</div>'); resultsContainer.show(); }
                        }, error: function () { console.log('Lỗi tìm kiếm'); }
                    });
                }, 300);
            });
            $(document).on('click', function (e) { if (!$(e.target).closest('.header-search-wrapper').length) { $('#searchResults').hide(); } });
        });
    </script>

    @if (User.Identity.IsAuthenticated && !User.IsInRole("Boss") && !User.IsInRole("Admin"))
    {
        <partial name="_ChatWidget" />
    }

    @RenderSection("Scripts", required: false)
</body>
</html>