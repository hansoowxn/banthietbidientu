@{
    ViewData["Title"] = "Trang chủ - SmartTech";
    var cultureInfo = new System.Globalization.CultureInfo("vi-VN");
}
@model IEnumerable<banthietbidientu.Models.SanPham>

@section Styles {
    <style>
        /* 1. Fix lỗi Toast và Modal bị che khuất */
        .toast-container {
            z-index: 100000 !important;
            top: 100px !important;
        }

        /* Đảm bảo Modal luôn nổi lên trên cùng */
        .modal {
            z-index: 100050 !important;
        }
        /* Lớp đen mờ phải nằm dưới Modal */
        .modal-backdrop {
            z-index: 100040 !important;
        }

        /* 2. CSS CAROUSEL BANNER MỚI */
        .carousel-item {
            height: 500px; /* Chiều cao banner */
            background-color: #000;
            position: relative;
        }

            .carousel-item img {
                object-fit: cover;
                height: 100%;
                width: 100%;
                opacity: 0.7; /* Làm tối ảnh nền để chữ nổi bật */
                filter: brightness(0.9);
            }

        /* Hiệu ứng Gradient phủ lên ảnh để text dễ đọc hơn */
        .carousel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 50%, rgba(0,0,0,0) 100%);
        }

        .carousel-caption {
            bottom: 35%;
            left: 10%;
            right: auto;
            text-align: left;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            max-width: 600px;
        }

            .carousel-caption h1 {
                font-weight: 900;
                font-size: 3.5rem;
                text-transform: uppercase;
                letter-spacing: 1px;
                margin-bottom: 1rem;
                line-height: 1.2;
            }

            .carousel-caption p {
                font-size: 1.3rem;
                font-weight: 400;
                margin-bottom: 2rem;
                opacity: 0.9;
            }

        .btn-hero {
            padding: 12px 40px;
            font-weight: 700;
            border-radius: 50px;
            text-transform: uppercase;
            font-size: 1rem;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            z-index: 10;
        }

            .btn-hero:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            }

        /* 3. CSS Product Card */
        .product-card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            border-radius: 15px;
            overflow: hidden;
            background: white;
            position: relative;
            z-index: 1;
        }

            .product-card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
                z-index: 10;
            }

        .product-img-container {
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            padding: 20px;
            position: relative;
        }

            .product-img-container img {
                max-height: 100%;
                max-width: 100%;
                object-fit: contain;
                transition: transform 0.5s;
            }

        .product-card-hover:hover .product-img-container img {
            transform: scale(1.05);
        }

        .badge-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 5;
        }

        /* 4. CSS cho Modal Chọn Loại */
        .option-btn {
            border: 1px solid #dee2e6;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
            min-width: 80px;
            text-align: center;
            user-select: none;
        }

            .option-btn:hover {
                border-color: #0d6efd;
                background: #f8f9fa;
            }

            .option-btn.active {
                border-color: #0d6efd;
                background-color: #e7f1ff;
                color: #0d6efd;
                font-weight: bold;
                box-shadow: 0 0 0 1px #0d6efd;
            }

        .color-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #dee2e6;
            position: relative;
            transition: transform 0.2s;
        }

            .color-btn:hover {
                transform: scale(1.1);
            }

            .color-btn.active {
                border-color: #0d6efd;
                transform: scale(1.1);
                box-shadow: 0 0 5px rgba(0,0,0,0.3);
            }

                .color-btn.active::after {
                    content: '\F26E';
                    font-family: "bootstrap-icons";
                    color: white;
                    font-size: 12px;
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    text-shadow: 0 0 2px rgba(0,0,0,0.5);
                }

        .card-actions {
            position: relative;
            z-index: 20;
        }

        .stretched-link {
            z-index: 2;
        }

        /* Custom Controls Carousel */
        .carousel-control-prev, .carousel-control-next {
            width: 5%;
            opacity: 0.7;
            z-index: 5;
        }

            .carousel-control-prev:hover, .carousel-control-next:hover {
                opacity: 1;
            }
    </style>
}

<!-- --- CAROUSEL SLIDER (GIỮ NGUYÊN) --- -->
<div class="container-fluid p-0 mb-5">
    <div id="smartTechCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="5000">

        <div class="carousel-indicators">
            <button type="button" data-bs-target="#smartTechCarousel" data-bs-slide-to="0" class="active"></button>
            <button type="button" data-bs-target="#smartTechCarousel" data-bs-slide-to="1"></button>
            <button type="button" data-bs-target="#smartTechCarousel" data-bs-slide-to="2"></button>
        </div>

        <div class="carousel-inner rounded-bottom-5 shadow-sm overflow-hidden" style="border-radius: 0 0 50px 50px;">
            <div class="carousel-item active">
                <img src="https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=1600&auto=format&fit=crop" alt="Tech World">
                <div class="carousel-overlay"></div>
                <div class="carousel-caption">
                    <h1 class="text-white">Chào mừng đến với SmartTech</h1>
                    <p>Thiên đường công nghệ chính hãng. Nơi cập nhật những xu hướng mới nhất 2025.</p>
                    <a href="#products" class="btn btn-primary btn-hero text-white">Khám Phá Ngay</a>
                </div>
            </div>
            <div class="carousel-item">
                <img src="https://images.unsplash.com/photo-1696446701796-da61225697cc?q=80&w=1600&auto=format&fit=crop" alt="iPhone 15">
                <div class="carousel-overlay"></div>
                <div class="carousel-caption">
                    <h1 class="text-warning">iPhone 16 Series</h1>
                    <p>Thiết kế Titan đẳng cấp. Hiệu năng vượt trội. <br>Sẵn hàng giao ngay trong 1 giờ.</p>
                    <a href="#products" class="btn btn-warning text-dark btn-hero">Đặt Hàng Ngay</a>
                </div>
            </div>
            <div class="carousel-item">
                <img src="https://images.unsplash.com/photo-1531297461136-82lw82b2e0d1?q=80&w=1600&auto=format&fit=crop" alt="Trade In">
                <div class="carousel-overlay"></div>
                <div class="carousel-caption">
                    <h1 class="text-success">Thu Cũ Đổi Mới</h1>
                    <p>Trợ giá lên đời tới <strong>2.000.000đ</strong>. <br>Định giá online nhanh chóng chỉ trong 5 phút.</p>
                    <a asp-controller="Home" asp-action="ThuMuaMayCu" class="btn btn-success text-white btn-hero">Định giá ngay</a>
                </div>
            </div>
        </div>

        <button class="carousel-control-prev" type="button" data-bs-target="#smartTechCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#smartTechCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
</div>

<!-- --- DANH SÁCH TẤT CẢ SẢN PHẨM  --- -->
<div class="container my-5" id="products">
    <div class="d-flex justify-content-between align-items-center mb-4 border-start border-5 border-primary ps-3">
        <h2 class="fw-bold text-dark m-0">Tất cả sản phẩm</h2>
    </div>

    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        @if (Model == null || !Model.Any())
        {
            <div class="col-12 text-center py-5">
                <p class="text-muted fs-5">Hiện chưa có sản phẩm nào!</p>
            </div>
        }
        else
        {
            @foreach (var product in Model)
            {
                <div class="col">
                    <div class="card h-100 product-card-hover shadow-sm">
                        <div class="badge-overlay">
                            @if (product.SoLuong < 1)
                            {
                                <span class="badge bg-danger shadow-sm">Hết hàng</span>
                            }
                            else
                            {
                                <span class="badge bg-primary shadow-sm">Mới</span>
                            }
                        </div>

                        <div class="product-img-container bg-light">
                            <img src="@(product.ImageUrl ?? "/images/default-product.png")"
                                 alt="@product.Name"
                                 onerror="this.src='/image/logo.png'">
                        </div>

                        <div class="card-body d-flex flex-column">
                            <div class="mb-2"><span class="badge bg-light text-secondary border">@product.Category</span></div>

                            <!-- Tên sản phẩm: Dùng z-index để không bị đè -->
                            <h5 class="card-title text-truncate" title="@product.Name" style="position: relative; z-index: 5;">
                                <a href="@Url.Action("ChiTietSanPham", "Home", new { id = product.Id })" class="text-decoration-none text-dark">@product.Name</a>
                            </h5>

                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="fs-5 fw-bold text-primary">@product.Price.ToString("N0", cultureInfo) ₫</span>
                                    <small class="text-muted">Kho: @product.SoLuong</small>
                                </div>

                                <!-- Nút thêm nhanh: Dùng z-index cao nhất -->
                                <div class="d-grid gap-2 card-actions" style="position: relative; z-index: 20;">
                                    @if (product.SoLuong > 0)
                                    {
                                        <button type="button" class="btn btn-primary w-100 rounded-pill fw-bold position-relative"
                                                style="z-index: 100;"
                                                onclick="event.stopPropagation(); openOptionModal(@product.Id, '@product.Name', @product.Price, '@(product.ImageUrl ?? "/images/default.jpg")')">
                                            <i class="bi bi-cart-plus me-1"></i> Thêm vào giỏ
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-secondary w-100 rounded-pill" disabled>Hết hàng</button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- DỊCH VỤ TIỆN ÍCH (Banner nhỏ dưới) -->
<div class="container my-5">
    <div class="row g-3">
        <div class="col-md-4">
            <div class="p-4 rounded-4 bg-light d-flex align-items-center gap-3 border border-light shadow-sm">
                <i class="bi bi-truck fs-1 text-primary"></i>
                <div>
                    <h6 class="fw-bold mb-1">Miễn phí vận chuyển</h6>
                    <small class="text-muted">Cho đơn hàng từ 5 triệu</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="p-4 rounded-4 bg-light d-flex align-items-center gap-3 border border-light shadow-sm">
                <i class="bi bi-shield-check fs-1 text-success"></i>
                <div>
                    <h6 class="fw-bold mb-1">Bảo hành chính hãng</h6>
                    <small class="text-muted">1 đổi 1 trong 30 ngày</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="p-4 rounded-4 bg-light d-flex align-items-center gap-3 border border-light shadow-sm">
                <i class="bi bi-headset fs-1 text-warning"></i>
                <div>
                    <h6 class="fw-bold mb-1">Hỗ trợ 24/7</h6>
                    <small class="text-muted">Hotline: 0965.629.698</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thêm Nhanh -->
<div class="modal fade" id="productOptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0">
                <div class="d-flex align-items-center my-3">
                    <img id="modalImg" src="" class="rounded border me-3" style="width: 80px; height: 80px; object-fit: contain;">
                    <div>
                        <h5 id="modalName" class="fw-bold text-dark mb-1"></h5>
                        <h4 id="modalPrice" class="fw-bold text-primary mb-0"></h4>
                    </div>
                </div>
                <hr class="opacity-25">
                <div class="mb-3">
                    <label class="fw-bold mb-2 text-muted small text-uppercase">Chọn phiên bản:</label>
                    <div class="d-flex flex-wrap gap-2" id="storageOptions"></div>
                </div>
                <div class="mb-4">
                    <label class="fw-bold mb-2 text-muted small text-uppercase">Chọn màu sắc:</label>
                    <div class="d-flex gap-3" id="colorOptions"></div>
                    <div id="colorName" class="small text-muted mt-1"></div>
                </div>
                <form id="addToCartForm" asp-controller="GioHang" asp-action="Add" method="post">
                    <input type="hidden" name="id" id="inputProductId" />
                    <input type="hidden" name="capacity" id="inputCapacity" />
                    <input type="hidden" name="color" id="inputColor" />
                    <input type="hidden" name="quantity" value="1" />
                    <button type="submit" class="btn btn-primary w-100 py-2 fw-bold rounded-pill shadow-sm">XÁC NHẬN THÊM VÀO GIỎ</button>
                </form>
            </div>
        </div>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1060;">
        <div id="successToast" class="toast align-items-center text-white bg-success border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body fs-6 fw-bold"><i class="bi bi-check-circle-fill me-2"></i> @TempData["Success"]</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        let currentBasePrice = 0;
        let selectedCapacityPrice = 0;

        document.addEventListener('DOMContentLoaded', function () {
            // FIX LỖI MÀN HÌNH ĐEN: Chuyển Modal ra ngoài cùng body
            var modalElement = document.getElementById('productOptionModal');
            document.body.appendChild(modalElement);

            // Toast
            var toastEl = document.getElementById('successToast');
            if (toastEl) {
                var toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
            }
        });

        function openOptionModal(id, name, price, img) {
            document.getElementById('inputProductId').value = id;
            document.getElementById('modalName').innerText = name;
            document.getElementById('modalImg').src = img;
            currentBasePrice = price;
            selectedCapacityPrice = 0;

            renderOptions();
            updatePriceDisplay();

            var myModal = new bootstrap.Modal(document.getElementById('productOptionModal'));
            myModal.show();
        }

        function renderOptions() {
            const storageDiv = document.getElementById('storageOptions');
            const colorDiv = document.getElementById('colorOptions');
            const inputCap = document.getElementById('inputCapacity');
            const inputColor = document.getElementById('inputColor');

            const capacities = [{ label: '64GB', priceAdd: 0 }, { label: '128GB', priceAdd: 500000 }, { label: '256GB', priceAdd: 1500000 }];
            const colors = [{ name: 'Đen', code: '#000' }, { name: 'Trắng', code: '#f8f9fa' }, { name: 'Xanh', code: '#0d6efd' }, { name: 'Vàng', code: '#ffc107' }];

            storageDiv.innerHTML = '';
            inputCap.value = capacities[0].label;
            selectedCapacityPrice = capacities[0].priceAdd;
            capacities.forEach((cap, index) => {
                let btn = document.createElement('div');
                btn.className = `option-btn ${index === 0 ? 'active' : ''}`;
                btn.innerText = cap.label;
                btn.onclick = function() {
                    document.querySelectorAll('#storageOptions .option-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedCapacityPrice = cap.priceAdd;
                    inputCap.value = cap.label;
                    updatePriceDisplay();
                };
                storageDiv.appendChild(btn);
            });

            colorDiv.innerHTML = '';
            inputColor.value = colors[0].name;
            document.getElementById('colorName').innerText = colors[0].name;
            colors.forEach((col, index) => {
                let btn = document.createElement('div');
                btn.className = `color-btn ${index === 0 ? 'active' : ''}`;
                btn.style.backgroundColor = col.code;
                btn.onclick = function() {
                    document.querySelectorAll('#colorOptions .color-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    inputColor.value = col.name;
                    document.getElementById('colorName').innerText = col.name;
                };
                colorDiv.appendChild(btn);
            });
        }

        function updatePriceDisplay() {
            let totalPrice = currentBasePrice + selectedCapacityPrice;
            document.getElementById('modalPrice').innerText = totalPrice.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }
    </script>
}