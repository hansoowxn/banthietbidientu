@model banthietbidientu.Models.TaiKhoan
@inject banthietbidientu.Services.MemberService MemberService

@{
    ViewData["Title"] = "Hồ sơ cá nhân - SmartTech";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Lấy thông tin hạng từ Service
    var tier = MemberService.GetUserTier(User.Identity.Name);

    // Mặc định
    string bgClass = "bg-standard";
    string borderClass = "border-standard";
    string badgeClass = "badge-standard";

    // --- [LOGIC MÀU SẮC ĐÃ SỬA] ---
    if (tier.CssClass == "tier-boss") // Boss
    {
        bgClass = "bg-boss";
        borderClass = "border-boss";
        badgeClass = "badge-boss";
    }
    else if (tier.CssClass == "tier-admin") // Admin
    {
        bgClass = "bg-admin";
        borderClass = "border-admin";
        badgeClass = "badge-admin";
    }
    else if (tier.TotalSpent >= 100000000) { bgClass = "bg-diamond"; borderClass = "border-diamond"; badgeClass = "badge-diamond"; }
    else if (tier.TotalSpent >= 50000000) { bgClass = "bg-platinum"; borderClass = "border-platinum"; badgeClass = "badge-platinum"; }
    else if (tier.TotalSpent >= 20000000) { bgClass = "bg-gold"; borderClass = "border-gold"; badgeClass = "badge-gold"; }
    else if (tier.TotalSpent >= 10000000) { bgClass = "bg-silver"; borderClass = "border-silver"; badgeClass = "badge-silver"; }
}

<style>
    /* --- CSS PROFILE --- */
    .profile-page-wrapper {
        min-height: 85vh;
        padding: 50px 0;
        transition: background 0.5s ease;
    }

    .bg-standard {
        background-color: #f8f9fa;
    }

    .bg-silver {
        background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%);
    }

    .bg-gold {
        background: linear-gradient(135deg, #fff8e1 0%, #fffde7 100%);
    }

    .bg-platinum {
        background: linear-gradient(135deg, #e0f7fa 0%, #e1f5fe 100%);
    }

    .bg-diamond {
        background: radial-gradient(circle at top, #2a2a72 0%, #009ffd 100%);
        color: white;
    }

    /* Admin: Xanh dương đậm */
    .bg-admin {
        background: radial-gradient(circle at center, #003366 0%, #000033 100%);
        color: white;
    }

    /* Boss: Đỏ quyền lực */
    .bg-boss {
        background: radial-gradient(circle at center, #8B0000 0%, #330000 100%);
        color: white;
    }

    .profile-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        transition: box-shadow 0.3s ease;
        border: 2px solid transparent;
    }

    .border-standard {
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-color: #dee2e6;
    }

    .border-silver {
        border-color: #bdc3c7;
        box-shadow: 0 0 20px rgba(189, 195, 199, 0.5);
    }

    .border-gold {
        border-color: #ffc107;
        box-shadow: 0 0 25px rgba(255, 193, 7, 0.4);
    }

    .border-platinum {
        border-color: #00bcd4;
        box-shadow: 0 0 25px rgba(0, 188, 212, 0.4);
    }

    .border-diamond {
        border-color: #d63031;
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
    }

    .border-admin {
        border-color: #0d6efd;
        box-shadow: 0 0 30px rgba(13, 110, 253, 0.3);
    }

    .border-boss {
        border-color: #ff3333;
        box-shadow: 0 0 30px rgba(255, 51, 51, 0.3);
    }

    .rank-badge {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 50px;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 1px;
        margin-top: 10px;
    }

    .badge-standard {
        background: #eee;
        color: #555;
    }

    .badge-silver {
        background: linear-gradient(to right, #bdc3c7, #2c3e50);
        color: white;
    }

    .badge-gold {
        background: linear-gradient(to right, #f1c40f, #b7950b);
        color: white;
    }

    .badge-platinum {
        background: linear-gradient(to right, #00bcd4, #006064);
        color: white;
    }

    .badge-diamond {
        background: linear-gradient(to right, #e84393, #6c5ce7);
        color: white;
        box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    .badge-admin {
        background: linear-gradient(to right, #0052cc, #003366);
        color: white;
        box-shadow: 0 0 10px rgba(0, 82, 204, 0.6);
    }

    .badge-boss {
        background: linear-gradient(to right, #cc0000, #800000);
        color: white;
        border: 1px solid #ff6666;
        box-shadow: 0 0 10px rgba(204, 0, 0, 0.6);
    }

    /* Digital Card */
    .digital-card {
        height: 180px;
        border-radius: 16px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        margin-bottom: 30px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    .card-bg-silver {
        background: linear-gradient(135deg, #bdc3c7, #2c3e50);
    }

    .card-bg-gold {
        background: linear-gradient(135deg, #f1c40f, #b7950b);
    }

    .card-bg-platinum {
        background: linear-gradient(135deg, #00bcd4, #006064);
    }

    .card-bg-diamond {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 1px solid rgba(255,255,255,0.2);
    }

    .card-bg-admin {
        background: linear-gradient(135deg, #0044cc, #002266);
        border: 1px solid #6699ff;
    }

    .card-bg-boss {
        background: linear-gradient(135deg, #8B0000, #330000);
        border: 1px solid #ff3333;
    }

    .card-bg-standard {
        background: linear-gradient(135deg, #6c757d, #343a40);
    }

    .card-chip {
        width: 45px;
        height: 30px;
        background: linear-gradient(135deg, #ffd700, #d4af37);
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .card-number {
        font-family: 'Courier New', monospace;
        font-size: 1.2rem;
        letter-spacing: 2px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
</style>

<div class="profile-page-wrapper @bgClass">
    <section class="container">
        <div class="row justify-content-center">
            <div class="col-lg-7 col-md-9">
                @if (Model != null)
                {
                    <div class="p-4 profile-card @borderClass">
                        <div class="text-center mb-4">
                            <div class="position-relative d-inline-block">
                                <i class="bi @tier.Icon display-3 text-primary"></i>
                                @if (tier.CssClass == "tier-boss")
                                {
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-white"><i class="bi bi-crown-fill"></i></span>
                                }
                                else if (tier.CssClass == "tier-admin")
                                {
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary border border-white"><i class="bi bi-shield-check"></i></span>
                                }
                            </div>
                            <h2 class="h3 fw-bold mt-3 mb-1 text-dark">Xin chào, @Model.FullName!</h2>
                            <div class="rank-badge @badgeClass shadow-sm">@tier.Name</div>

                            @if (tier.CssClass != "tier-boss" && tier.CssClass != "tier-admin")
                            {
                                <div class="mt-2 small text-muted">Chi tiêu: @tier.TotalSpent.ToString("#,##0") ₫</div>
                            }
                        </div>

                        <div class="digital-card @(tier.CssClass == "tier-boss" ? "card-bg-boss" : tier.CssClass == "tier-admin" ? "card-bg-admin" : tier.TotalSpent >= 100000000 ? "card-bg-diamond" : tier.TotalSpent >= 50000000 ? "card-bg-platinum" : tier.TotalSpent >= 20000000 ? "card-bg-gold" : tier.TotalSpent >= 10000000 ? "card-bg-silver" : "card-bg-standard")">
                            <div class="d-flex justify-content-between">
                                <div class="card-chip shadow-sm"></div>
                                <div class="small fw-bold opacity-75">SMARTTECH MEMBER</div>
                            </div>
                            <div class="card-number">**** **** **** @(Math.Abs(User.Identity.Name.GetHashCode() % 10000).ToString("0000"))</div>
                            <div class="d-flex justify-content-between small text-uppercase">
                                <div>@Model.FullName</div>
                                <div>@(tier.CssClass == "tier-boss" || tier.CssClass == "tier-admin" ? "LIFETIME" : "EXP: 12/30")</div>
                            </div>
                        </div>

                        <h5 class="h6 text-uppercase text-primary fw-bold mb-3">Quyền lợi hiện tại</h5>
                        <div class="row g-3 mb-4">
                            @* --- 👑 BOSS (50%) --- *@
                            @if (tier.CssClass == "tier-boss")
                            {
                                <div class="col-4"><div class="p-3 border border-danger bg-danger bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-percent text-danger fs-3 mb-2 d-block"></i><div class="fw-bold text-danger">Giảm 50%</div><small class="text-muted">Mọi đơn hàng</small></div></div>
                                <div class="col-4"><div class="p-3 border border-danger bg-danger bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-truck text-danger fs-3 mb-2 d-block"></i><div class="fw-bold text-danger">Free Ship</div><small class="text-muted">Không giới hạn</small></div></div>
                                <div class="col-4"><div class="p-3 border border-danger bg-danger bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-shield-check text-danger fs-3 mb-2 d-block"></i><div class="fw-bold text-danger">Quyền Lực</div><small class="text-muted">Quản lý toàn bộ</small></div></div>
                            }
                            @* --- 🛡️ ADMIN (25%) --- *@
                            else if (tier.CssClass == "tier-admin")
                            {
                                <div class="col-4"><div class="p-3 border border-primary bg-primary bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-percent text-primary fs-3 mb-2 d-block"></i><div class="fw-bold text-primary">Giảm 25%</div><small class="text-muted">Mọi đơn hàng</small></div></div>
                                <div class="col-4"><div class="p-3 border border-primary bg-primary bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-truck text-primary fs-3 mb-2 d-block"></i><div class="fw-bold text-primary">Free Ship</div><small class="text-muted">Không giới hạn</small></div></div>
                                <div class="col-4"><div class="p-3 border border-primary bg-primary bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-shop text-primary fs-3 mb-2 d-block"></i><div class="fw-bold text-primary">Quản Lý</div><small class="text-muted">1 Chi nhánh</small></div></div>
                            }
                            @* --- 💎 KIM CƯƠNG (10%) --- *@
                            else if (tier.TotalSpent >= 100000000)
                            {
                                <div class="col-4"><div class="p-3 border border-dark bg-dark bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-percent text-dark fs-3 mb-2 d-block"></i><div class="fw-bold text-dark">Giảm 10%</div><small class="text-muted">Trên tổng đơn</small></div></div>
                                <div class="col-4"><div class="p-3 border border-dark bg-dark bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-truck text-dark fs-3 mb-2 d-block"></i><div class="fw-bold text-dark">Free Ship</div><small class="text-muted">Toàn quốc</small></div></div>
                                <div class="col-4"><div class="p-3 border border-dark bg-dark bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-gift text-dark fs-3 mb-2 d-block"></i><div class="fw-bold text-dark">Quà VIP</div><small class="text-muted">Dịp sinh nhật</small></div></div>
                            }
                            @* --- 🌟 BẠCH KIM (5%) --- *@
                            else if (tier.TotalSpent >= 50000000)
                            {
                                <div class="col-4"><div class="p-3 border border-info bg-info bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-percent text-info fs-3 mb-2 d-block"></i><div class="fw-bold text-info">Giảm 5%</div><small class="text-muted">Trên tổng đơn</small></div></div>
                                <div class="col-4"><div class="p-3 border border-info bg-info bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-truck text-info fs-3 mb-2 d-block"></i><div class="fw-bold text-info">Free Ship</div><small class="text-muted">Toàn quốc</small></div></div>
                                <div class="col-4"><div class="p-3 border border-info bg-info bg-opacity-10 rounded-3 text-center h-100"><i class="bi bi-headset text-info fs-3 mb-2 d-block"></i><div class="fw-bold text-info">Ưu Tiên</div><small class="text-muted">Hỗ trợ 24/7</small></div></div>
                            }
                            @* --- VÀNG/BẠC/THƯỜNG (Chỉ hiện FreeShip) --- *@
                            else
                            {
                                <div class="col-12"><div class="p-3 border bg-light rounded-3 text-center"><i class="bi bi-truck text-muted fs-3 mb-2 d-block"></i><div class="fw-bold text-muted">Ưu đãi vận chuyển</div><small class="text-muted">Theo chính sách thành viên</small></div></div>
                            }
                        </div>

                        <h5 class="h6 text-uppercase text-primary fw-bold mb-3">Thông tin cá nhân</h5>
                        <ul class="list-group list-group-flush border rounded-3 mb-5">
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3"><span class="text-muted"><i class="bi bi-person-vcard me-2"></i> Họ và Tên</span><strong class="text-dark">@Model.FullName</strong></li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3"><span class="text-muted"><i class="bi bi-calendar-date me-2"></i> Ngày sinh</span><strong class="text-dark">@Model.DateOfBirth.Value.ToString("dd/MM/yyyy")</strong></li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3"><span class="text-muted"><i class="bi bi-geo-alt me-2"></i> Địa chỉ</span><strong class="text-dark text-end ms-3 text-break">@(Model.Address ?? "Chưa cung cấp")</strong></li>
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3"><span class="text-muted"><i class="bi bi-envelope me-2"></i> Email</span><strong class="text-dark">@Model.Email</strong></li>
                        </ul>

                        <h5 class="h6 text-uppercase text-primary fw-bold mb-3">Tùy chọn tài khoản</h5>
                        <div class="list-group rounded-3 overflow-hidden border">
                            <a asp-action="EditProfile" asp-controller="Login" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3"><span class="fw-medium"><i class="bi bi-pencil-square me-3 text-info"></i>Chỉnh sửa thông tin</span><i class="bi bi-chevron-right text-muted"></i></a>
                            <a asp-action="ChangePassword" asp-controller="Login" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3"><span class="fw-medium"><i class="bi bi-key-fill me-3 text-warning"></i>Đổi mật khẩu</span><i class="bi bi-chevron-right text-muted"></i></a>
                            <a asp-action="LichSuMuaHang" asp-controller="Login" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3"><span class="fw-medium"><i class="bi bi-clock-history me-3 text-success"></i>Lịch sử mua hàng</span><i class="bi bi-chevron-right text-muted"></i></a>
                        </div>

                        <hr class="my-5">
                        <form asp-action="Logout" asp-controller="Login" method="post" class="d-grid"><button type="submit" class="btn btn-outline-danger btn-lg fw-medium" style="border-radius: 8px;"><i class="bi bi-box-arrow-right me-2"></i> Đăng xuất</button></form>
                    </div>
                }
                else
                {
                    <div class="p-5 bg-white rounded-3 border shadow-sm text-center">
                        <i class="bi bi-exclamation-triangle-fill display-3 text-warning mb-3"></i><h2 class="h3 fw-bold mt-3 mb-3">Bạn chưa đăng nhập</h2><a asp-action="DangNhap" asp-controller="Login" class="btn btn-primary btn-lg fw-medium"><i class="bi bi-box-arrow-in-right me-2"></i> Đăng nhập ngay</a>
                    </div>
                }
            </div>
        </div>
    </section>
</div>