@model List<banthietbidientu.Models.HistoryViewModel>

@{
    ViewData["Title"] = "Lịch sử mua hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* CSS Card đơn hàng */
    .order-card {
        border: 1px solid #eee;
        border-radius: 12px;
        transition: all 0.3s ease;
        background: #fff;
        overflow: hidden;
    }

        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-color: #0d6efd;
        }

    /* CSS Badge Trạng thái */
    .status-badge {
        font-size: 0.85rem;
        padding: 6px 12px;
        border-radius: 30px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    /* Màu sắc trạng thái */
    .badge-success {
        background-color: #28a745;
        color: white;
    }

    .badge-primary {
        background-color: #0d6efd;
        color: white;
    }

    .badge-info {
        background-color: #0dcaf0;
        color: #000;
    }

    .badge-warning {
        background-color: #ffc107;
        color: #000;
    }

    .badge-danger {
        background-color: #dc3545;
        color: white;
    }

    .product-img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #f0f0f0;
    }
</style>

<div class="container py-5" style="min-height: 80vh;">

    <div class="d-flex align-items-center mb-4">
        <h2 class="fw-bold text-dark mb-0">
            <i class="bi bi-bag-check-fill text-primary me-2"></i>Đơn hàng của tôi
        </h2>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success shadow-sm mb-4 border-0 border-start border-5 border-success">
            <i class="bi bi-check-circle-fill me-2"></i> @TempData["Success"]
        </div>
    }

    <div class="row justify-content-center">
        <div class="col-lg-10">
            @if (Model != null && Model.Any())
            {
                foreach (var donHang in Model)
                {
                    // --- LOGIC MÀU SẮC TRẠNG THÁI ---
                    string badgeClass = "badge-secondary";
                    string iconClass = "bi-question-circle";

                    if (donHang.TrangThai == "Chờ xử lý") { badgeClass = "badge-warning"; iconClass = "bi-hourglass-split"; }
                    else if (donHang.TrangThai == "Đã xác nhận") { badgeClass = "badge-info"; iconClass = "bi-clipboard-check"; }
                    else if (donHang.TrangThai == "Đang giao") { badgeClass = "badge-primary"; iconClass = "bi-truck"; }
                    else if (donHang.TrangThai == "Hoàn thành") { badgeClass = "badge-success"; iconClass = "bi-check-circle-fill"; }
                    else if (donHang.TrangThai == "Đã hủy") { badgeClass = "badge-danger"; iconClass = "bi-x-circle-fill"; }

                    // --- [MỚI] TÍNH TOÁN GIẢM GIÁ ---
                    decimal tongTienHang = donHang.SanPhams.Sum(sp => (sp.Gia ?? 0) * sp.SoLuong);
                    decimal soTienGiam = tongTienHang - donHang.TongTien; // Tiền hàng - Tiền thực trả
                    // --------------------------------

                    <div class="order-card mb-4">
                        <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light bg-opacity-25">
                            <div>
                                <span class="fw-bold text-dark me-2">#@donHang.MaDon</span>
                                <span class="text-muted small">| @donHang.NgayDat.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>
                            <span class="status-badge @badgeClass shadow-sm">
                                <i class="bi @iconClass"></i> @donHang.TrangThai
                            </span>
                        </div>

                        <div class="p-3">
                            @if (donHang.SanPhams != null)
                            {
                                foreach (var item in donHang.SanPhams)
                                {
                                    <div class="d-flex align-items-center mb-3">
                                        <img src="@(item.SanPham?.ImageUrl ?? "/images/default.png")" class="product-img me-3" onerror="this.src='/images/default.png'">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-bold text-dark">@(item.SanPham?.Name ?? "Sản phẩm")</h6>
                                            <div class="small text-muted">
                                                Số lượng: <span class="fw-bold text-dark">x@(item.SoLuong)</span>
                                            </div>
                                        </div>
                                        <div class="text-end fw-bold text-primary">
                                            @((item.Gia ?? 0).ToString("#,##0")) đ
                                        </div>
                                    </div>
                                }
                            }
                        </div>

                        <div class="p-3 bg-light border-top d-flex justify-content-between align-items-center">
                            <div>
                                @if (soTienGiam > 0)
                                {
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="text-muted small me-2">Tiền hàng:</span>
                                        <span class="text-decoration-line-through text-muted small">@tongTienHang.ToString("#,##0") đ</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="text-success small fw-bold me-2"><i class="bi bi-gift-fill"></i> Giảm giá:</span>
                                        <span class="text-success fw-bold small">-@soTienGiam.ToString("#,##0") đ</span>
                                    </div>
                                    <div class="border-top pt-1 mt-1">
                                        <span class="text-dark small fw-bold">Tổng thanh toán:</span>
                                        <span class="fs-5 fw-bold text-danger ms-2">@donHang.TongTien.ToString("#,##0") đ</span>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted small">Tổng tiền:</span>
                                    <span class="fs-5 fw-bold text-danger ms-2">@donHang.TongTien.ToString("#,##0") đ</span>
                                }
                            </div>

                            <a asp-action="ChiTietDonHang" asp-controller="Login" asp-route-id="@donHang.MaDon"
                               class="btn btn-primary fw-bold shadow-sm rounded-pill px-4">
                                Xem chi tiết
                            </a>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/2038/2038854.png" style="width: 150px; opacity: 0.5;" class="mb-3">
                    <h4 class="text-muted fw-bold">Chưa có đơn hàng nào</h4>
                    <p class="text-muted mb-4">Hãy dạo một vòng và chọn món đồ yêu thích nhé!</p>
                    <a href="/" class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm fw-bold">
                        Mua sắm ngay
                    </a>
                </div>
            }
        </div>
    </div>
</div>